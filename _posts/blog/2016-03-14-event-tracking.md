---
layout: post
title: 埋点方案汇总
description: 各种数据埋点方案的汇总。你家的数据埋点做得好吗？
category: blog
---

目前业界日志数据的生产工具主要有反向代理服务器 Nginx 和后端程序员自己代码中的log日志。

一个典型的数据平台，对于数据的处理，是由如下的5个步骤组成的：
![photo1](/images/event-tracking/1-2.png)
其中，第一个步骤，也即数据采集是最核心的问题。数据采集是否丰富，采集的数据是否准确，采集是否及时，都直接影响整个数据平台的应用的效果。

数据接入方案有几个确定的基本原则：

**1、优先在后端接入数据**

如果一个event，它的信息在前端和后端都能采集到，建议优先在后端采集数据。例如，通过手机APP“提交订单”这个事件，在APP端和服务器端都可以拿到这个事件的细节，包括但不限于商品名称、价格、品类、店铺等信息，建议尽量在服务器端采集数据。
 
在后端采集数据可以避免以下一些问题：
 
- 客户端采集数据，通常情况下为了尽量减少对用户体验的影响，需要对采集的数据进行暂存、压缩，并且仅在网络条件良好的情况下才通过公网发送数据，从而会带来数据传输延迟、数据长时间为发送导致缓存区溢出丢数据等弊端。而在服务端采集数据，传输时都是内网到内网，数据的延迟和丢失的问题要小很多。
- 客户端采集数据，如果要调整事件和属性的采集方案，需要修改客户端的代码，则需要一定的时间周期来发布新版本，等待用户更新新版本，而且通常情况下，很多用户并不会及时更新客户端，从而导致很多采集策略无法覆盖到所有用户。在服务端采集数据则没有这些问题。

基于以上这些问题，除非某个行为只在前端能够采集，否则都建议在后端采集数据。

**2、属性尽可能采集全面**

在设计要采集的属性字段时，一个基本原则，就是采集尽可能全面。

例如，在采集订单相关的几个事件，例如“提交订单”、“支付订单”、“接收订单”等，在每个事件的属性采集时，都应该把对应的商品的信息，例如商品名称、价格、品类、店铺等，都采集起来。这样，在分析这几个事件时，就都可以用到这些字段的信息了。

虽然看似在不同字段收集了一些冗余的字段，但是由于我们的存储引擎的存储特性，并不需要过多担心因此而造成的存储浪费和查询性能的弱化，还是以信息的丰富完善为主。


下面是我做的一些关于埋点技术的调研结果和看法。

### 业务服务器同时做数据报数

##### 解释：

用户手机发出一个请求，服务器接受请求，返回请求数据，但同时服务器写下一条日志数据。

##### 缺点：

- 日志数据内容受限。业务请求的url与需要采集数据的url发生冲突，以及为了不暴露过多信息而使用简短的url，把真正的展现内容处理交给后端，都会使nginx无法收集到有价值的日志数据。
- 缓存技术导致日志采集太复杂，静态页面导致采集不到数据。缓存，动态页面静态化，等减轻服务器压力的技术，都会导致数据采集非常复杂，必须后端工程师在每个业务模块都手动添加埋点，工作量也很大。
- IOS和Android，还有很多H5的只需在前端交互不会访问后端的动作数据无法采集。
- 违反了技术发展趋势，使为了降低成本和提升效率而设计的各种技术方案失效。

### 前端可视化埋点

##### 解释：

因前端埋点代价大，每一个埋点都需要写代码，那么，就参考 Visual Studio 等一系列现代 IDE 的做法，用可视化交互手段来代替写代码即可；既然每次埋点更新都需要等待APP的更新，那么，就参考现在很多手游的做法，把核心代码和配置、资源分开，在APP启动的时候通过网络更新配置和资源即可。

##### 优点：

- 解放程序员，非技术人员自己就可以做埋点，解决了代码埋点代价大的问题
- 通过服务端配置埋点，解决了等待APP更新的问题

##### 缺点：

- 覆盖功能有限，并不是所有的控件操作都可以通过这种方案进行定制，只适合收集设备、地域、网络等默认属性以及一些全局公共属性
- 具有所有APP前端埋点的共同缺点，即没有解决传输时效性和数据可靠性的问题

##### 国外与国内：

以 Mixpanel 为首的数据分析服务商，都相继提供了可视化埋点的方案，Mixpanel将之称作为 codeless。Mixpanel 开源了它们的iOS 和 Android 端的 SDK 的[源代码](https://github.com/mixpanel)，要使用需要一定的技术投入。

国内的 TalkingData、诸葛IO、GrowingIO 等也都提供了类似的技术手段。

下图是演示一个简单的 iOS SDK 使用 Mixpanel 的 codeless 埋点功能：
![photo2](/images/event-tracking/2-2.png)

### 无埋点

##### 解释：

很直白，就是不需要埋点，每一个用户动作都可收集，但是原理与第一条跟业务服务器耦合在一起的那种数据收集方式完全不同。

##### 原理：

有css选择器技术，还有监听手机控件的事件触发技术等。

以下解释来源[知乎](https://www.zhihu.com/question/38000812/answer/83267604)：

> 大多对于可交互式的应用程序，例如Android应用，iOS应用，网站，Windows Phone应用，Windows的窗体程序、Java的窗体程序等等，其实在界面渲染时都有几点共性：
> 1. 图形背后都有图形树，我们所看到的输入框、文本框、按钮等等其实都是view，而view的摆放其实也都是有对应的视图方式，例如线性布局、网格布局、表格布局、相对、绝对等等，然后view加布局就组成了我们要看到的界面，比如最简单的就是网站的DOM结构了，有层级关系，对于Android而言就是View视图的层级关系了，调用系统级API基本上都能获取这个树结果。
> 2. 窗体都有生命周期，比如Android的Activity的生命周期
> 3. 对于我们可视的这些界面元素，当他们显示出来、被点击了、被选中了、被滑动等等操作的时候，系统也都会有相应的接口给开发者通知他们去处理，所以也就是对于View而言可以绑定或者委托或者是监听他们的一些触发事件，比如刚刚提到的加载、点击、选中等操作。
>
> 讲到这里，应该很清楚了，应用程序在呈现程序界面的时候，其实有一套生命周期的准则在里面，控制了从界面元素创造到响应用户操作到销毁，同时也有一个图形树的准则在里面，控制了这些界面元素的显示层级和顺序，最后在用户交互（包括展现）各个界面元素的时候，会给开发者提供一系列的接口，让开发者去处理这些行为。
>
> 所以原理清楚了，后续无埋点其实也就能想到怎么做了，现在市面上主流有两种，一种是预先跟踪所有的渲染信息，一种是滞后跟踪的渲染信息。两种做法不太一样，后者要简单一些，前者要重一些，但是也有一些办法优化（不交互的元素肯定多于交互元素），各家也就都有自己的方法在里面。

##### 优点：

- 解决了代码埋点代价大的问题
- 解决了等待APP更新的问题
- 从部署 SDK 的时候数据就一直都在收集，解决了数据“回溯”的问题
- 可以自动获取很多启发性的信息，例如，“无埋点”可以告诉使用者这个界面上每个控件分别被点击的概率是多大，哪些控件值得做更进一步的分析等等

##### 缺点：

- 覆盖的功能有限，不能灵活地自定义属性。
- 具有所有APP前端埋点的共同缺点，即没有解决传输时效性和数据可靠性的问题。
- 由于所有的控件事件都全部搜集，会给服务器和网络传输带来更大的负载，给用户带来更多的移动数据成本和耗电，此外还有相关的隐私风险。

### 前端代码埋点

代码埋点出现的时间很早了，在 Google Analytics 年代，就已经出现了类似的方案了。目前，国内的主要第三方数据分析服务商，如百度统计、友盟、TalkingData 等都提供了这一方案。Sensors Analytics 也一样提供了 iOS、Android、Web 等主流平台的代码埋点方案。

##### 原理：

在APP或者界面初始化的时候，初始化数据分析的SDK，然后在某个事件发生时就调用SDK里面相应的数据发送接口发送数据。例如，我们想统计APP里面某个按钮的点击次数，则在APP的某个按钮被点击时，可以在这个按钮对应的 OnClick 函数里面调用SDK提供的数据发送接口来发送数据。

##### 优点：

- 使用者控制精准，可以非常精确地选择什么时候发送数据。
- 可以比较方便地设置自定义属性、自定义事件，传递比较丰富的数据到服务端。

##### 缺点：

- 代码埋点代价大。每一个控件的埋点都需要添加相应的代码，不仅工作量大，而且限定了必须是技术人员才能完成。
- 需要等待APP更新。每一次更新埋点方案，都必须改代码，然后通过各个应用市场进行分发，并且总会有相当多数量的用户不喜欢更新APP，这样埋点代码也就得不到更新了。
- 具有所有APP前端埋点的共同缺点，即没有解决传输时效性和数据可靠性的问题，这个问题就只能通过尽量减少前端收集，多在后端收集数据来解决了。

